{% extends "base.html" %}

{% block title %}나의 예약 현황 - Court-Kok{% endblock %}

{% block content %}
<div class="w-full max-w-5xl mx-auto flex flex-col" style="min-height: 80vh;">
  {% include 'includes/header.html' %}

  <main class="bg-white p-6 md:p-8 rounded-2xl shadow-lg flex-grow">
    <div class="flex items-center justify-between gap-3 mb-6">
      <h1 class="text-3xl font-bold text-gray-900 border-b pb-2 flex-1">나의 예약 현황</h1>
    </div>

    <div class="mb-8">
      <div class="inline-flex rounded-xl border border-gray-200 p-1 bg-gray-50">
        <button data-filter="upcoming"
                class="filter-tab px-4 py-2 text-sm font-medium rounded-lg bg-white shadow-sm">다가올 모임</button>
        <button data-filter="past"
                class="filter-tab px-4 py-2 text-sm font-medium rounded-lg text-gray-600">지난 모임</button>
        <button data-filter="all"
                class="filter-tab px-4 py-2 text-sm font-medium rounded-lg text-gray-600">전체</button>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <section>
        <h2 class="text-2xl font-semibold text-gray-900 mb-4">내가 만든 모임</h2>
        <div id="created-events-container" class="space-y-4">
          <div class="animate-pulse space-y-3">
            <div class="h-24 bg-emerald-50/60 rounded-xl"></div>
            <div class="h-24 bg-emerald-50/60 rounded-xl"></div>
          </div>
        </div>
      </section>

      <section>
        <h2 class="text-2xl font-semibold text-gray-900 mb-4">내가 참여할 모임</h2>
        <div id="attended-events-container" class="space-y-4">
          <div class="animate-pulse space-y-3">
            <div class="h-24 bg-green-50/60 rounded-xl"></div>
            <div class="h-24 bg-green-50/60 rounded-xl"></div>
          </div>
        </div>
      </section>
    </div>
  </main>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  // --- Elements ---
  const createdBox   = document.getElementById('created-events-container');
  const attendedBox  = document.getElementById('attended-events-container');
  const filterTabs   = Array.from(document.querySelectorAll('.filter-tab'));

  // --- State ---
  const state = {
    created: [],
    attended: [],
    filter: 'upcoming', // upcoming | past | all
  };

  // --- Helpers ---
  const escapeHtml = (s) => String(s ?? '')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');

  function toKstDate(dateStr, timeStr) {
    if (!dateStr) return null;
    const t = (timeStr || '00:00').padStart(5, '0');
    const iso = `${dateStr}T${t}:00+09:00`;
    const dt = new Date(iso);
    return isNaN(dt.getTime()) ? null : dt;
  }

  function isUpcoming(dt) {
    if (!dt) return false;
    const now = new Date();
    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    return dt >= todayStart;
  }

  function ddayLabel(dt) {
    if (!dt) return '';
    const now = new Date();
    const oneDay = 24 * 60 * 60 * 1000;
    const startToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const startThat  = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
    const diff = Math.round((startThat - startToday) / oneDay);
    if (diff === 0) return 'D-Day';
    if (diff > 0)  return `D-${diff}`;
    return `D+${Math.abs(diff)}`;
  }

  function prettyDateTime(dt) {
    if (!dt) return '-';
    try {
      return new Intl.DateTimeFormat('ko-KR', {
        timeZone: 'Asia/Seoul',
        year: 'numeric', month: '2-digit', day: '2-digit',
        weekday: 'short', hour: '2-digit', minute: '2-digit'
      }).format(dt);
    } catch {
      return dt.toLocaleString();
    }
  }

  function showSkeleton() {
    createdBox.innerHTML = `
      <div class="animate-pulse space-y-3">
        <div class="h-24 bg-emerald-50/60 rounded-xl"></div>
        <div class="h-24 bg-emerald-50/60 rounded-xl"></div>
      </div>`;
    attendedBox.innerHTML = `
      <div class="animate-pulse space-y-3">
        <div class="h-24 bg-green-50/60 rounded-xl"></div>
        <div class="h-24 bg-green-50/60 rounded-xl"></div>
      </div>`;
  }

  // ▼▼▼ [수정된 부분] ▼▼▼
  function renderCard(ev, scheme) {
    const dt = toKstDate(ev.date, ev.time);
    const badge = ddayLabel(dt);
    const countNow = Array.isArray(ev.participants) ? ev.participants.length : 0;
    // description 값을 안전하게 가져옵니다.
    const description = escapeHtml(ev.description) || '모임 설명 없음';

    const accent = scheme === 'emerald'
      ? { ring: 'ring-emerald-200', title: 'text-emerald-700', chip: 'bg-emerald-100 text-emerald-700' }
      : { ring: 'ring-green-200', title: 'text-green-700', chip: 'bg-green-100 text-green-700' };

    return `
      <div class="rounded-xl border border-gray-200 ring-1 ${accent.ring} bg-white overflow-hidden">
        <div class="p-4">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h3 class="text-lg font-bold ${accent.title} truncate" title="${description}">
                ${description}
              </h3>
              <p class="text-sm font-semibold text-gray-700 mt-1">
                ${escapeHtml(ev.date)} · ${escapeHtml(ev.time)}
              </p>
              <p class="text-sm text-gray-600 mt-1">${prettyDateTime(dt)}</p>
              <div class="mt-2 flex flex-wrap items-center gap-2">
                <span class="inline-flex items-center px-2 py-0.5 text-xs rounded-full ${accent.chip}">
                  ${badge}
                </span>
                <span class="inline-flex items-center px-2 py-0.5 text-xs rounded-full bg-gray-100 text-gray-700">
                  ${escapeHtml(ev.duration)}분
                </span>
                <span class="inline-flex items-center px-2 py-0.5 text-xs rounded-full bg-gray-100 text-gray-700">
                  ${countNow} / ${escapeHtml(ev.max_participants)}명
                </span>
              </div>
            </div>
            ${
              scheme === 'emerald'
              ? `<button class="delete-btn text-xs md:text-sm bg-gray-800 hover:bg-black text-white font-semibold py-2 px-3 md:px-4 rounded-lg"
                         data-event-id="${escapeHtml(ev._id)}">모임 삭제</button>`
              : `<button class="cancel-btn text-xs md:text-sm bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-3 md:px-4 rounded-lg"
                         data-event-id="${escapeHtml(ev._id)}">예약 취소</button>`
            }
          </div>
          <div class="mt-4 pt-4 border-t">
            ${
              scheme === 'emerald'
              ? renderParticipants(ev)
              : renderHost(ev)
            }
          </div>
        </div>
      </div>
    `;
  }
  // ▲▲▲ [수정된 부분] ▲▲▲

  function renderParticipants(ev) {
    const parts = Array.isArray(ev.participants_details) ? ev.participants_details : [];
    if (parts.length === 0) {
      return `<p class="text-sm text-gray-500">참가자가 아직 없습니다.</p>`;
    }
    const preview = parts.slice(0,5).map(p =>
      `<li>${escapeHtml(p.name)} (${escapeHtml(p.id)}) - ${escapeHtml(p.phone)}</li>`
    ).join('');
    const rest = parts.slice(5).map(p =>
      `<li>${escapeHtml(p.name)} (${escapeHtml(p.id)}) - ${escapeHtml(p.phone)}</li>`
    ).join('');
    const hasMore = parts.length > 5;
    const moreHtml = hasMore
      ? `<ul class="list-disc list-inside text-sm text-gray-600 hidden" data-more="list">${rest}</ul>
         <button type="button" class="mt-2 text-sm text-emerald-600 hover:underline" data-more="toggle">더 보기</button>`
      : '';
    return `
      <h4 class="font-semibold text-gray-800">참가자 목록</h4>
      <ul class="list-disc list-inside mt-2 text-sm text-gray-600">${preview}</ul>
      ${moreHtml}
    `;
  }

  function renderHost(ev) {
    const cd = ev.creator_details || {};
    const hostLine = `${escapeHtml(cd.name ?? 'N/A')} (${escapeHtml(cd.id ?? 'N/A')}) - ${escapeHtml(cd.phone ?? 'N/A')}`;
    return `
      <h4 class="font-semibold text-gray-800">주최자 정보</h4>
      <p class="text-sm text-gray-600 mt-2">${hostLine}</p>
    `;
  }

  function renderLists() {
    createdBox.innerHTML = '';
    attendedBox.innerHTML = '';

    const created = (Array.isArray(state.created) ? state.created : [])
      .slice()
      .sort((a,b) => (toKstDate(b.date,b.time) - toKstDate(a.date,a.time))); // 최신순 정렬
    const attended = (Array.isArray(state.attended) ? state.attended : [])
      .slice()
      .sort((a,b) => (toKstDate(b.date,b.time) - toKstDate(a.date,a.time))); // 최신순 정렬

    const filteredCreated = created.filter(ev => {
      const dt = toKstDate(ev.date, ev.time);
      if (state.filter === 'all') return true;
      return state.filter === 'upcoming' ? isUpcoming(dt) : !isUpcoming(dt);
    });
    const filteredAttended = attended.filter(ev => {
      const dt = toKstDate(ev.date, ev.time);
      if (state.filter === 'all') return true;
      return state.filter === 'upcoming' ? isUpcoming(dt) : !isUpcoming(dt);
    });

    if (filteredCreated.length === 0) {
      createdBox.innerHTML = `<p class="text-gray-500">표시할 모임이 없습니다.</p>`;
    } else {
      for (const ev of filteredCreated) {
        createdBox.insertAdjacentHTML('beforeend', renderCard(ev, 'emerald'));
      }
    }

    if (filteredAttended.length === 0) {
      attendedBox.innerHTML = `<p class="text-gray-500">표시할 모임이 없습니다.</p>`;
    } else {
      for (const ev of filteredAttended) {
        attendedBox.insertAdjacentHTML('beforeend', renderCard(ev, 'green'));
      }
    }
  }

  // --- WS & API ---
  function sendGetMyRegistrations() {
    if (!window.ws || ws.readyState !== WebSocket.OPEN) return;
    showLoader();
    ws.send(JSON.stringify({ action: 'get_my_registrations' }));
    const timeoutMs = 7000;
    const marker = Symbol('loading');
    createdBox._loadingMarker = marker;
    setTimeout(() => {
      if (createdBox._loadingMarker === marker) {
        hideLoader();
        createdBox.innerHTML  = `<p class="text-gray-500">데이터를 불러오지 못했습니다. 새로고침해 주세요.</p>`;
        attendedBox.innerHTML = `<p class="text-gray-500">데이터를 불러오지 못했습니다. 새로고침해 주세요.</p>`;
        showAlert('예약 데이터를 불러오지 못했습니다. 잠시 후 다시 시도해 주세요.');
      }
    }, timeoutMs);
  }

  if (typeof connectWebSocket === 'function') {
    connectWebSocket();
  } else {
    console.error('connectWebSocket()가 없습니다. base.html을 확인하세요.');
    return;
  }
  if (!window.ws) {
    console.error('ws 전역이 없습니다. base.html의 connectWebSocket()에서 ws를 설정해야 합니다.');
    return;
  }

  ws.addEventListener('open', sendGetMyRegistrations);
  ws.addEventListener('close', () => {
    console.warn('웹소켓 연결이 종료되었습니다.');
  });

  ws.addEventListener('message', (event) => {
    let data;
    try { data = JSON.parse(event.data); } catch { return; }

    switch (data.type) {
      case 'my_registrations_data': {
        state.created  = Array.isArray(data.created_events)  ? data.created_events  : [];
        state.attended = Array.isArray(data.attended_events) ? data.attended_events : [];
        createdBox._loadingMarker = undefined;
        hideLoader();
        renderLists();
        break;
      }
      case 'event_update': {
        sendGetMyRegistrations();
        break;
      }
    }
  });

  // --- Interactions ---
  filterTabs.forEach(tab => {
    tab.addEventListener('click', () => {
      filterTabs.forEach(t => {
        t.classList.remove('bg-white','shadow-sm','text-gray-900');
        t.classList.add('text-gray-600');
      });
      tab.classList.add('bg-white','shadow-sm');
      tab.classList.remove('text-gray-600');
      state.filter = tab.dataset.filter;
      renderLists();
    });
  });

  [createdBox, attendedBox].forEach(box => {
    box.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-more="toggle"]');
      if (!btn) return;
      const list = btn.parentElement.querySelector('[data-more="list"]');
      if (list) {
        const opened = !list.classList.contains('hidden');
        list.classList.toggle('hidden');
        btn.textContent = opened ? '더 보기' : '접기';
      }
    });
  });

  createdBox.addEventListener('click', async (e) => {
    const btn = e.target.closest('.delete-btn');
    if (!btn) return;
    if (!confirm('이 모임을 완전히 삭제합니다. 계속할까요?')) return;
    showLoader();
    try {
      const eventId = btn.dataset.eventId;
      const response = await authedFetch(`/api/events/${eventId}`, { method: 'DELETE' });
      const result = await response.json().catch(() => ({}));
      showAlert(result.message ?? '모임이 삭제되었습니다.');
    } catch (err) {
      showAlert('삭제에 실패했습니다. 다시 시도해 주세요.');
    } finally {
      hideLoader();
    }
  });

  attendedBox.addEventListener('click', async (e) => {
    const btn = e.target.closest('.cancel-btn');
    if (!btn) return;
    if (!confirm('예약을 취소하시겠습니까?')) return;
    showLoader();
    try {
      const eventId = btn.dataset.eventId;
      const response = await authedFetch(`/api/events/${eventId}/signup`, { method: 'DELETE' });
      const result = await response.json().catch(() => ({}));
      showAlert(result.message ?? '예약이 취소되었습니다.');
    } catch (err) {
      showAlert('예약 취소에 실패했습니다. 다시 시도해 주세요.');
    } finally {
      hideLoader();
    }
  });
});
</script>
{% endblock %}